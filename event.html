<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8">
  <title>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/hero/image.png" sizes="any">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gray-900 text-white">
  <div id="bg" class="fixed inset-0 -z-10 bg-cover bg-center opacity-50"></div>

  <main class="min-h-screen grid place-items-center px-4 py-10">
    <div class="w-full max-w-3xl rounded-3xl bg-white text-slate-900 p-8 shadow-2xl">
      <h1 id="evTitle" class="text-2xl font-extrabold text-center mb-6">Project CE Event</h1>

      <div class="space-y-6">
        <div>
          <h2 class="text-xl font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
          <p id="evDesc" class="leading-7 text-slate-700">Present All Project Since CE02 - CE05</p>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <span class="font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
            <span id="evDate">2025-10-17</span>
          </div>
          <div>
            <span class="font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</span>
            <span id="evLoc">Room E107</span>
          </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
        <div id="registrationSection">
          <div class="pt-2">
            <h2 class="text-xl font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
            <input id="address" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
              class="w-full rounded-xl bg-indigo-100 px-4 py-3 outline-none ring-1 ring-indigo-300 focus:ring-2 focus:ring-indigo-500">
          </div>

          <div class="pt-2 flex justify-end">
            <button id="submitBtn"
              class="px-6 py-2.5 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-500 active:scale-[.99]">
              ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
            </button>
          </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß -->
        <div id="alreadyRegistered" class="hidden">
          <div class="pt-2 text-center">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-100 text-blue-700">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"></path>
              </svg>
              <span class="font-semibold">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
          </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô) -->
        <div id="adminView" class="hidden">
          <div class="pt-2">
            <h2 class="text-xl font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
            <div class="w-full rounded-xl bg-gray-100 px-4 py-3 text-gray-500">
              ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...
            </div>
          </div>

          <div class="pt-2 text-center">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-gray-200 text-gray-600">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"></path>
              </svg>
              <span class="font-semibold">‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden">
      <div data-overlay class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="relative z-10 min-h-full p-4 grid place-items-center">
        <div class="relative w-[560px] max-w-[calc(100vw-2rem)] rounded-2xl bg-white text-slate-900 p-6 shadow-2xl">
          <button id="cmClose"
            class="absolute right-3 top-3 h-9 w-9 grid place-items-center rounded-full hover:bg-black/5">
            ‚úï
          </button>
          <p class="text-center text-lg font-semibold mb-6">
            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          </p>
          <div class="flex justify-center gap-3">
            <button id="cmCancel" class="px-5 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button id="cmOk" class="px-6 py-2 rounded-xl bg-green-600 text-white hover:bg-green-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
  <a href="./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html"
    class="fixed bottom-5 right-5 h-12 w-12 grid place-items-center rounded-full bg-white text-black shadow-xl">üè†</a>

  <script>
    const API_BASE =
      (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:4000/api'
        : '/api';

    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const token = localStorage.getItem("token") || "";

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å history ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const fromHistory = document.referrer.includes('HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html') &&
      sessionStorage.getItem('fromHistory') === 'true';

    if (!id) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (id)");
      location.href = "./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html";
    }

    // JWT Decode
    function parseJwt(t) {
      try {
        const payload = t.split(".")[1];
        const b64 = payload.replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(b64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join(""));
        return JSON.parse(json);
      } catch {
        return {};
      }
    }

    const claims = token ? parseJwt(token) : {};
    const role = (claims.role || claims.user?.role || "").toLowerCase();
    const isAdmin = role === "admin";

    const modal = document.getElementById("confirmModal");
    const btnSubmit = document.getElementById("submitBtn");
    const addressInput = document.getElementById("address");
    const registrationSection = document.getElementById("registrationSection");
    const alreadyRegistered = document.getElementById("alreadyRegistered");
    const adminView = document.getElementById("adminView");

    const openModal = () => modal.classList.remove("hidden");
    const closeModal = () => modal.classList.add("hidden");

    document.getElementById("cmClose").onclick = closeModal;
    document.getElementById("cmCancel").onclick = closeModal;
    modal.addEventListener('click', (e) => { if (e.target.hasAttribute('data-overlay')) closeModal(); });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    async function checkRegistrationStatus() {
      if (!token) return false;

      try {
        const res = await fetch(`${API_BASE}/registrations/me`, {
          headers: { Authorization: 'Bearer ' + token },
          credentials: 'include'
        });

        if (res.ok) {
          const data = await res.json();
          const items = data.items || data.registrations || [];
          return items.some(item => {
            const eventId = item.event?._id || item.eventId || item.event;
            return eventId === id;
          });
        }
      } catch (error) {
        console.error('Error checking registration:', error);
      }
      return false;
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    async function loadEvent() {
      try {
        const res = await fetch(`${API_BASE}/events/${id}`, { credentials: "include" });
        if (!res.ok) throw new Error(String(res.status));
        const ev = await res.json();

        document.getElementById("evTitle").textContent = ev.title || "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°";
        document.getElementById("evDesc").textContent = ev.description || "‚Äî";
        document.getElementById("evDate").textContent = ev.dateText || "‚Äî";
        document.getElementById("evLoc").textContent = ev.location || "‚Äî";
        if (ev.imageUrl) document.getElementById("bg").style.backgroundImage = `url('${ev.imageUrl}')`;

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin: ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)
        if (isAdmin) {
          registrationSection.classList.add("hidden");
          alreadyRegistered.classList.add("hidden");
          adminView.classList.remove("hidden");
          return;
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        const isRegistered = await checkRegistrationStatus();

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å history ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        if (fromHistory || isRegistered) {
          registrationSection.classList.add("hidden");
          alreadyRegistered.classList.remove("hidden");
          // ‡∏•‡πâ‡∏≤‡∏á sessionStorage
          sessionStorage.removeItem('fromHistory');
        }

      } catch (e) {
        alert("‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏û‡∏ö");
        location.href = "./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html";
      }
    }

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    async function doRegister() {
      if (!token) {
        alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        location.href = "./index.html";
        return;
      }
      const address = (addressInput?.value || "").trim();

      try {
        const res = await fetch(`${API_BASE}/events/${id}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          credentials: "include",
          body: JSON.stringify({ address })
        });

        closeModal();

        if (res.status === 409) {
          alert("‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          registrationSection.classList.add("hidden");
          alreadyRegistered.classList.remove("hidden");
          return;
        }

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || `HTTP ${res.status}`);
        }

        alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        registrationSection.classList.add("hidden");
        alreadyRegistered.classList.remove("hidden");
      } catch (e) {
        alert("‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
    async function updateEvent() {
      const title = document.getElementById("evTitle").textContent.trim();
      const description = document.getElementById("evDesc").textContent.trim();
      const dateText = document.getElementById("evDate").textContent.trim();
      const location = document.getElementById("evLoc").textContent.trim();

      try {
        const res = await fetch(`${API_BASE}/events/${id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          credentials: "include",
          body: JSON.stringify({ title, description, dateText, location })
        });

        if (!res.ok) throw new Error((await res.json()).message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      } catch (e) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: " + e.message);
      }
    }

    // ‡πÇ‡∏´‡∏°‡∏î Admin - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
    if (isAdmin) {
      ['evTitle', 'evDesc', 'evDate', 'evLoc'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('click', () => {
          el.contentEditable = "true";
          el.focus();
          el.style.backgroundColor = "#e0f2ff";
        });
        el.addEventListener('blur', () => {
          el.contentEditable = "false";
          el.style.backgroundColor = "";
        });
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
      saveBtn.className = "mt-6 px-6 py-2.5 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-500 active:scale-[.99]";
      document.querySelector(".space-y-6").appendChild(saveBtn);
      saveBtn.addEventListener("click", updateEvent);
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    if (!isAdmin) {
      btnSubmit?.addEventListener("click", openModal);
      document.getElementById("cmOk").addEventListener("click", doRegister);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadEvent();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('‚úÖ Service Worker registered'))
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>
</body>

</html>