<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/hero/image.png" sizes="any">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gray-900 text-white">
  <div id="bg" class="fixed inset-0 -z-10 bg-cover bg-center opacity-50"></div>

  <main class="min-h-screen grid place-items-center px-4 py-10">
    <div class="w-full max-w-3xl rounded-3xl bg-white text-slate-900 p-8 shadow-2xl">
      <h1 id="evTitle" class="text-2xl font-extrabold text-center mb-6">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>

      <div class="space-y-6">
        <div>
          <h2 class="text-xl font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
          <p id="evDesc" class="leading-7 text-slate-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡πà‡∏≤</p>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <span class="font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
            <span id="evDate">2025-10-04</span>
          </div>
          <div>
            <span class="font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</span>
            <span id="evLoc">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</span>
          </div>
        </div>

        <div class="pt-2">
          <h2 class="text-xl font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
          <input id="address" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
            class="w-full rounded-xl bg-indigo-100 px-4 py-3 outline-none ring-1 ring-indigo-300 focus:ring-2 focus:ring-indigo-500">
        </div>

        <div class="pt-2 flex justify-end">
          <button id="submitBtn"
            class="px-6 py-2.5 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-500 active:scale-[.99]">
            ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden">
      <div data-overlay class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="relative z-10 min-h-full p-4 grid place-items-center">
        <div class="relative w-[560px] max-w-[calc(100vw-2rem)] rounded-2xl bg-white text-slate-900 p-6 shadow-2xl">
          <button id="cmClose"
            class="absolute right-3 top-3 h-9 w-9 grid place-items-center rounded-full hover:bg-black/5">
            ‚úï
          </button>
          <p class="text-center text-lg font-semibold mb-6">
            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          </p>
          <div class="flex justify-center gap-3">
            <button id="cmCancel" class="px-5 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button id="cmOk"
              class="px-6 py-2 rounded-xl bg-green-600 text-white hover:bg-green-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
  <a href="./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html"
    class="fixed bottom-5 right-5 h-12 w-12 grid place-items-center rounded-full bg-white text-black shadow-xl">üè†</a>

  <script>
    const API_BASE =
      (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:4000/api'
        : '/api';

    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const token = localStorage.getItem("token") || "";

    if (!id) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (id)");
      location.href = "./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html";
    }

    // JWT Decode
    function parseJwt(t) {
      try {
        const payload = t.split(".")[1];
        const b64 = payload.replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(b64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join(""));
        return JSON.parse(json);
      } catch {
        return {};
      }
    }

    const claims = token ? parseJwt(token) : {};
    const role = (claims.role || claims.user?.role || "").toLowerCase();
    const isAdmin = role === "admin";

    const modal = document.getElementById("confirmModal");
    const btnSubmit = document.getElementById("submitBtn");
    const addressInput = document.getElementById("address");
    const openModal = () => modal.classList.remove("hidden");
    const closeModal = () => modal.classList.add("hidden");

    document.getElementById("cmClose").onclick = closeModal;
    document.getElementById("cmCancel").onclick = closeModal;
    modal.addEventListener('click', (e) => { if (e.target.hasAttribute('data-overlay')) closeModal(); });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    async function loadEvent() {
      try {
        const res = await fetch(`${API_BASE}/events/${id}`, { credentials: "include" });
        if (!res.ok) throw new Error(String(res.status));
        const ev = await res.json();

        document.getElementById("evTitle").textContent = ev.title || "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°";
        document.getElementById("evDesc").textContent = ev.description || "‚Äî";
        document.getElementById("evDate").textContent = ev.dateText || "‚Äî";
        document.getElementById("evLoc").textContent = ev.location || "‚Äî";
        if (ev.imageUrl) document.getElementById("bg").style.backgroundImage = `url('${ev.imageUrl}')`;
      } catch (e) {
        alert("‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏û‡∏ö");
        location.href = "./HOME‡∏ô‡∏®‡∏ó‡∏ï‡∏Å‡∏•‡∏ó‡∏ö.html";
      }
    }

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    async function doRegister() {
      if (!token) {
        alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        location.href = "./index.html";
        return;
      }
      const address = (addressInput?.value || "").trim();

      try {
        const res = await fetch(`${API_BASE}/events/${id}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          credentials: "include",
          body: JSON.stringify({ address })
        });

        closeModal();

        if (res.status === 409) {
          alert("‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
          return;
        }

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || `HTTP ${res.status}`);
        }

        alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      } catch (e) {
        alert("‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
    async function updateEvent() {
      const title = document.getElementById("evTitle").textContent.trim();
      const description = document.getElementById("evDesc").textContent.trim();
      const dateText = document.getElementById("evDate").textContent.trim();
      const location = document.getElementById("evLoc").textContent.trim();

      try {
        const res = await fetch(`${API_BASE}/events/${id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          credentials: "include",
          body: JSON.stringify({ title, description, dateText, location })
        });

        if (!res.ok) throw new Error((await res.json()).message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      } catch (e) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: " + e.message);
      }
    }

    // ‡πÇ‡∏´‡∏°‡∏î Admin
    if (isAdmin) {
      ['evTitle', 'evDesc', 'evDate', 'evLoc'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('click', () => { el.contentEditable = "true"; el.focus(); el.style.backgroundColor = "#e0f2ff"; });
        el.addEventListener('blur', () => { el.contentEditable = "false"; el.style.backgroundColor = ""; });
      });
      btnSubmit?.remove();
      addressInput?.remove();
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      saveBtn.className ="mt-6 px-6 py-2.5 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-500 active:scale-[.99]";
      document.querySelector(".space-y-6").appendChild(saveBtn);
      saveBtn.addEventListener("click", updateEvent);
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°
    btnSubmit?.addEventListener("click", openModal);
    document.getElementById("cmOk").addEventListener("click", doRegister);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadEvent();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('‚úÖ Service Worker registered'))
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>
</body>
</html>
