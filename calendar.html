<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Event Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link rel="icon" href="assets/hero/image.png" sizes="any">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    body{ font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; }
    .day-cell{ position:relative; }
    .day-badge{ position:absolute; right:.5rem; top:.5rem; font-size:.75rem; color:rgb(100 116 139); }
    .dot{ width:6px;height:6px;border-radius:9999px;background:#4f46e5;position:absolute;left:10px;bottom:10px;box-shadow:0 0 0 3px rgba(79,70,229,.15); }
    .chip{ font-size:.75rem; display:inline-block; padding:.25rem .5rem; border-radius:9999px; background:rgba(79,70,229,.08); color:#111827; border:1px solid rgba(79,70,229,.18) }
    .skeleton{ background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size:400% 100%; animation:shimmer 1.2s ease infinite; }
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
    .modal-enter{ transform:scale(.98); opacity:0 }
    .modal-enter-active{ transform:scale(1); opacity:1; transition:all .18s ease }
  </style>
</head>
<body class="bg-white text-slate-900">
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 h-16 flex items-center relative">
    <!-- ซ้าย: โลโก้ -->
    <a href="./HOMEนศทตกลทบ.html" class="font-extrabold text-xl tracking-tight">RLTG</a>

    <!-- กลาง: ปุ่ม Prev/เดือน/Next ถูก "จัดกลางทั้งแถบ" ด้วย absolute -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
      <div class="pointer-events-auto flex items-center gap-2">
        <button id="btnPrev"
                class="h-10 px-3 rounded-xl border border-slate-300 hover:bg-slate-50">
          ← Prev
        </button>

        <div id="monthLabel"
             class="min-w-[10ch] text-center font-semibold tabular-nums"></div>

        <button id="btnNext"
                class="h-10 px-3 rounded-xl border border-slate-300 hover:bg-slate-50">
          Next →
        </button>
      </div>
    </div>
  </div>
</header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Legend -->
    <div class="mb-4 flex items-center gap-4 text-sm">
      <span class="inline-flex items-center gap-2 text-slate-600">
        <span class="dot relative static"></span> มีรายการกิจกรรม
      </span>
      <span class="chip">ชื่อกิจกรรม</span>
    </div>

    <!-- Calendar -->
    <section class="rounded-2xl border border-slate-200 overflow-hidden">
      <!-- Day names -->
      <div class="grid grid-cols-7 bg-slate-50/80 border-b border-slate-200">
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Sunday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Monday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Tuesday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Wednesday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Thursday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Friday</div>
        <div class="py-2 text-center text-xs font-semibold text-slate-500">Saturday</div>
      </div>

      <!-- Grid -->
      <div id="grid" class="grid grid-cols-7 gap-px bg-slate-200"></div>
    </section>

    <!-- List (for current month) -->
    <section class="mt-8 rounded-2xl border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 bg-slate-50/80 border-b border-slate-200 font-semibold">รายการในเดือนนี้</div>
      <div id="listWrap" class="p-4">
        <div id="listLoading" class="h-10 rounded-lg skeleton"></div>
        <ul id="list" class="hidden space-y-2"></ul>
        <div id="listEmpty" class="hidden text-slate-500">ไม่มีรายการในเดือนนี้</div>
      </div>
    </section>
  </main>

  <!-- FAB: กลับหน้าแรก -->
  <a href="./HOMEนศทตกลทบ.html"
     class="fixed bottom-6 right-6 h-14 w-14 rounded-full bg-slate-900 text-white grid place-items-center shadow-xl hover:bg-slate-800 active:scale-95 transition"
     title="กลับหน้าแรก" aria-label="กลับหน้าแรก">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor">
      <path d="M3 10.5l9-7 9 7V20a2 2 0 01-2 2h-5v-6H10v6H5a2 2 0 01-2-2v-9.5z"/>
    </svg>
  </a>

  <!-- ========= Event Modal ========= -->
  <div id="eventModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 min-h-full p-4 grid place-items-center">
      <div class="modal-enter w-[720px] max-w-[calc(100vw-2rem)] rounded-2xl bg-white text-slate-900 shadow-2xl border border-slate-200">
        <div class="flex items-start justify-between px-6 pt-5">
          <div class="pr-10">
            <div id="emTitle" class="text-xl font-bold">—</div>
            <div id="emDate" class="text-sm text-slate-500 mt-1">—</div>
          </div>
          <button id="emClose" class="h-9 w-9 grid place-items-center rounded-full hover:bg-black/5" aria-label="ปิด">✕</button>
        </div>

        <div class="px-6 pt-3 pb-2 text-sm text-slate-600">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <div class="mb-1 text-xs font-semibold uppercase text-slate-400">สถานที่</div>
              <div id="emLoc" class="rounded-lg border border-slate-200 px-3 py-2 bg-slate-50/60">—</div>
            </div>
            <div>
              <div class="mb-1 text-xs font-semibold uppercase text-slate-400">address (ตอนลงทะเบียน)</div>
              <div id="emAddr" class="rounded-lg border border-slate-200 px-3 py-2 bg-slate-50/60">—</div>
            </div>
          </div>

          <div class="mt-4">
            <div class="mb-1 text-xs font-semibold uppercase text-slate-400">รายละเอียด</div>
            <div id="emDesc" class="rounded-lg border border-slate-200 px-3 py-3 bg-slate-50/60 min-h-[72px]">—</div>
          </div>

          <!-- หากวันเดียวกันมีหลายกิจกรรม -->
          <div id="emSwitcherWrap" class="mt-5 hidden">
            <div class="mb-2 text-xs font-semibold uppercase text-slate-400">กิจกรรมอื่นในวันเดียวกัน</div>
            <div id="emSwitcher" class="flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div class="px-6 pb-6 pt-2 flex items-center justify-end gap-3">
          <button id="emCancel" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-500 active:scale-[.99]">
            ยกเลิกการลงทะเบียน
          </button>
          <button id="emClose2" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 active:scale-[.99]">
            ปิด
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========= Confirm Modal ========= -->
  <div id="confirmModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]"></div>
    <div class="relative z-10 min-h-full p-4 grid place-items-center">
      <div class="w-[540px] max-w-[calc(100vw-2rem)] rounded-2xl bg-white text-slate-900 shadow-2xl border border-slate-200 modal-enter">
        <div class="px-6 py-5">
          <div class="text-lg font-semibold mb-4">คุณต้องการยกเลิกกิจกรรมนี้ใช่หรือไม่</div>
          <div class="text-sm text-slate-600" id="cmEvent">—</div>
        </div>
        <div class="px-6 pb-6 flex items-center justify-end gap-3">
          <button id="cmNo" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">ปิด</button>
          <button id="cmYes" class="px-5 py-2 rounded-xl bg-green-600 text-white hover:bg-green-500">ยืนยัน</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG / UTILS ====
    const API_BASE =
      (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:4000/api' : '/api';

    const TH_MONTH = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
    function pad(n){ return String(n).padStart(2,'0'); }
    function keyOfDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function parseDateLike(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00'); const d=new Date(s); return isNaN(d)?null:d; }
    function toDisplayDate(d){ const day=d.getDate(); const month=d.getMonth()+1; const y=d.getFullYear()+543; return `${day}/${month}/${String(y).slice(-2)}`; }

    // ==== GLOBAL MODAL HELPERS (ล็อกสกอลล์ + แอนิเมชัน) ====
    function showModal(wrapper){
      wrapper.classList.remove('hidden');
      document.documentElement.classList.add('overflow-hidden');
      const panel = wrapper.querySelector('.modal-enter');
      if (panel) requestAnimationFrame(()=> panel.classList.add('modal-enter-active'));
    }
    function hideModal(wrapper){
      const panel = wrapper.querySelector('.modal-enter');
      if (panel) panel.classList.remove('modal-enter-active');
      setTimeout(()=>{
        wrapper.classList.add('hidden');
        document.documentElement.classList.remove('overflow-hidden');
      }, 180);
    }

    // ==== STATE ====
    let allRegs = [];          // list of my registrations
    let byDate = new Map();    // YYYY-MM-DD -> [{reg, ev, date}]
    let viewYear, viewMonth;

    // modal state
    let currentItems = [];     // items of selected day
    let currentIndex = 0;      // selected item index

    // ==== DOM ====
    const $label = document.getElementById('monthLabel');
    const $grid = document.getElementById('grid');
    const $list = document.getElementById('list');
    const $listEmpty = document.getElementById('listEmpty');
    const $listLoading = document.getElementById('listLoading');

    // event modal DOM
    const em = {
      wrap: document.getElementById('eventModal'),
      title: document.getElementById('emTitle'),
      date: document.getElementById('emDate'),
      loc: document.getElementById('emLoc'),
      desc: document.getElementById('emDesc'),
      addr: document.getElementById('emAddr'),
      switcherWrap: document.getElementById('emSwitcherWrap'),
      switcher: document.getElementById('emSwitcher'),
      btnCancel: document.getElementById('emCancel'),
      btnClose: document.getElementById('emClose'),
      btnClose2: document.getElementById('emClose2'),
    };

    // confirm modal DOM
    const cm = {
      wrap: document.getElementById('confirmModal'),
      text: document.getElementById('cmEvent'),
      yes: document.getElementById('cmYes'),
      no: document.getElementById('cmNo'),
    };

    // ==== FETCH ====
    async function fetchMyRegistrations(){
      const token = localStorage.getItem('token');
      if (!token){ location.href = './index.html'; return []; }
      const opt = { headers: { Authorization: 'Bearer ' + token }, credentials: 'include' };
      let res = await fetch(`${API_BASE}/registrations/me`, opt);
      if (res.status === 404) res = await fetch(`${API_BASE}/auth/my-registrations`, opt);
      if (!res.ok) throw new Error('โหลดรายการไม่สำเร็จ');
      const j = await res.json().catch(()=> ({}));
      return j.items || [];
    }
    function indexByDate(items){
      const map = new Map();
      for (const it of items){
        const ev = it.event || {};
        const d = parseDateLike(ev.dateText);
        if (!d) continue;
        const k = keyOfDate(d);
        if (!map.has(k)) map.set(k, []);
        map.get(k).push({ reg: it, ev, date: d });
      }
      return map;
    }

    // ==== RENDER CALENDAR ====
    function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
    function firstWeekday(y, m){ return new Date(y, m, 1).getDay(); } // 0=Sun

    function drawMonth(y, m){
      viewYear = y; viewMonth = m;
      $label.textContent = `${TH_MONTH[m]} ${y+543}`;

      $grid.innerHTML = '';
      const dcount = daysInMonth(y, m);
      const start = firstWeekday(y, m);

      const totalCells = 42;
      const cells = [];
      const prevDays = start;
      const prevMonthDays = daysInMonth(y, m-1 < 0 ? 11 : m-1);
      for (let i = prevDays; i > 0; i--){
        const day = prevMonthDays - i + 1;
        const d = new Date(y, m-1, day);
        cells.push({ d, muted: true });
      }
      for (let day = 1; day <= dcount; day++){
        cells.push({ d: new Date(y, m, day), muted: false });
      }
      let n=1;
      while (cells.length < totalCells){
        cells.push({ d: new Date(y, m+1, n++), muted: true });
      }

      for (const cell of cells){
        const k = keyOfDate(cell.d);
        const items = byDate.get(k) || [];

        const wrap = document.createElement('button');
        wrap.type = 'button';
        wrap.className = 'day-cell bg-white text-left ' +
          (cell.muted ? 'text-slate-400' : 'text-slate-800') +
          ' min-h-[110px] p-3 focus:outline-none focus:ring-2 focus:ring-indigo-400 ' +
          (items.length ? 'hover:bg-indigo-50/40 cursor-pointer' : '');

        const badge = document.createElement('div');
        badge.className = 'day-badge';
        badge.textContent = cell.d.getDate();
        wrap.appendChild(badge);

        if (items.length){
          const dot = document.createElement('span');
          dot.className = 'dot';
          wrap.appendChild(dot);

          const inner = document.createElement('div');
          inner.className = 'mt-6 space-y-1';
          items.slice(0,2).forEach(({ev})=>{
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = ev.title || '(ไม่ระบุชื่อกิจกรรม)';
            inner.appendChild(chip);
          });
          if (items.length > 2){
            const more = document.createElement('div');
            more.className = 'text-xs text-slate-500';
            more.textContent = `+${items.length-2} รายการ`;
            inner.appendChild(more);
          }
          wrap.appendChild(inner);

          wrap.addEventListener('click', ()=> openEventModal(items, 0));
        }

        $grid.appendChild(wrap);
      }

      drawListForMonth(y, m);
    }

    function drawListForMonth(y, m){
      $list.innerHTML = '';
      $list.classList.add('hidden');
      $listEmpty.classList.add('hidden');
      $listLoading.classList.remove('hidden');

      const monthItems = [];
      for (const [k, arr] of byDate.entries()){
        const [Y, M] = k.split('-').map(Number);
        if (Y === y && (M-1) === m){
          monthItems.push(...arr);
        }
      }
      monthItems.sort((a,b)=> a.date - b.date);

      $listLoading.classList.add('hidden');
      if (!monthItems.length){ $listEmpty.classList.remove('hidden'); return; }

      const frag = document.createDocumentFragment();
      monthItems.forEach(({ev, date, reg})=>{
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-200 px-4 py-3 hover:bg-slate-50';
        li.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="inline-block h-2 w-2 rounded-full bg-indigo-600"></span>
            <div>
              <div class="font-semibold">${(ev.title || '(ไม่ระบุชื่อกิจกรรม)')}</div>
              <div class="text-sm text-slate-500">${toDisplayDate(date)} • ${(ev.location || '—')}</div>
            </div>
          </div>
          <button class="text-sm px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800">ดูรายละเอียด</button>
        `;
        li.querySelector('button').addEventListener('click', ()=> {
          openEventModal([ {ev, date, reg} ], 0);
        });
        frag.appendChild(li);
      });

      $list.appendChild(frag);
      $list.classList.remove('hidden');
    }

    // ==== MODALS ====
    function fillEventModal(){
      const item = currentItems[currentIndex];
      if (!item) return;

      const { ev, date, reg } = item;
      em.title.textContent = ev.title || '(ไม่ระบุชื่อกิจกรรม)';
      em.date.textContent = `${toDisplayDate(date)}`;
      em.loc.textContent = ev.location || '—';
      em.desc.textContent = ev.description || '—';
      em.addr.textContent = reg.address || '—';

      // switcher
      if (currentItems.length > 1){
        em.switcherWrap.classList.remove('hidden');
        em.switcher.innerHTML = '';
        currentItems.forEach((it, i)=>{
          const b = document.createElement('button');
          b.className = 'px-3 py-1.5 rounded-full border ' +
            (i===currentIndex ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-300 hover:bg-slate-50');
          b.textContent = it.ev.title || `กิจกรรม ${i+1}`;
          b.addEventListener('click', ()=>{ currentIndex = i; fillEventModal(); });
          em.switcher.appendChild(b);
        });
      } else {
        em.switcherWrap.classList.add('hidden');
      }

      // ยกเลิก
      em.btnCancel.onclick = ()=> openConfirmModal(item);
    }

    function openEventModal(items, index){
      currentItems = items; currentIndex = index || 0;
      fillEventModal(); showModal(em.wrap);
    }
    em.btnClose.addEventListener('click', ()=> hideModal(em.wrap));
    em.btnClose2.addEventListener('click', ()=> hideModal(em.wrap));
    em.wrap.addEventListener('click', (e)=>{ if(e.target === em.wrap) hideModal(em.wrap); });

    function openConfirmModal(item){
      cm.text.textContent = (item.ev.title || '(ไม่ระบุชื่อกิจกรรม)') + ' • ' + toDisplayDate(item.date);
      cm.yes.onclick = ()=> doCancel(item);
      cm.no.onclick = ()=> hideModal(cm.wrap);
      showModal(cm.wrap);
    }
    cm.wrap.addEventListener('click', (e)=>{ if(e.target === cm.wrap) hideModal(cm.wrap); });

    async function doCancel(item){
      cm.yes.disabled = true;
      try{
        const token = localStorage.getItem('token');
        await fetch(`${API_BASE}/registrations/${item.reg._id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        // update local state
        allRegs = allRegs.filter(r => r._id !== item.reg._id);
        byDate = indexByDate(allRegs);
        drawMonth(viewYear, viewMonth);
        hideModal(cm.wrap); hideModal(em.wrap);
      }catch(e){ alert('ยกเลิกไม่สำเร็จ'); }
      finally{ cm.yes.disabled = false; }
    }

    // ==== INIT ====
    (async function init(){
      // guard: admin ไม่ให้ใช้หน้า calendar → กลับหน้าแรก
      try{
        const token = localStorage.getItem('token');
        const meRes = await fetch(`${API_BASE}/auth/me`, { headers:{Authorization:'Bearer '+token}, credentials:'include' });
        if (meRes.ok){
          const meJson = await meRes.json().catch(()=>({}));
          const me = meJson.user || meJson;
          if (me?.role === 'admin'){ location.href = './HOMEนศทตกลทบ.html'; return; }
        } else {
          location.href='./index.html'; return;
        }
      }catch{ location.href='./index.html'; return; }

      const now = new Date();
      viewYear = now.getFullYear(); viewMonth = now.getMonth();

      try{
        allRegs = await fetchMyRegistrations();
        byDate = indexByDate(allRegs);
      }catch(e){
        $listLoading.classList.add('hidden');
        $listEmpty.classList.remove('hidden');
        $listEmpty.textContent = 'โหลดข้อมูลไม่สำเร็จ';
      }

      drawMonth(viewYear, viewMonth);

      document.getElementById('btnPrev').addEventListener('click', ()=>{
        const d = new Date(viewYear, viewMonth - 1, 1);
        drawMonth(d.getFullYear(), d.getMonth());
      });
      document.getElementById('btnNext').addEventListener('click', ()=>{
        const d = new Date(viewYear, viewMonth + 1, 1);
        drawMonth(d.getFullYear(), d.getMonth());
      });

      // ESC ปิดโมดัล
      document.addEventListener('keydown', e=>{
        if (e.key === 'Escape'){ hideModal(em.wrap); hideModal(cm.wrap); }
      });
    })();
  </script>
</body>
</html>